<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Drone Simulator with Block Coding</title>

  <!-- THREE JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

  <!-- BLOCKLY (STABLE VERSION) -->
  <script src="https://cdn.jsdelivr.net/npm/blockly@10.4.3/blockly.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/blockly@10.4.3/javascript.min.js"></script>

  <style>
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    #scene {
      width: 70%;
      height: 100%;
    }

    #blocklyArea {
      width: 30%;
      height: 100%;
      position: relative;
      background: #f0f0f0;
    }

    #blocklyDiv {
      position: absolute;
      width: 100%;
      height: 100%;
    }

    #runButton {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
      padding: 10px 20px;
      font-size: 16px;
    }
  </style>
</head>

<body>

<button id="runButton">Run Code</button>

<div id="scene"></div>

<div id="blocklyArea">
  <div id="blocklyDiv"></div>
</div>

<script>
/* =========================
   THREE JS DRONE SIMULATION
========================= */

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87CEEB);

const camera = new THREE.PerspectiveCamera(
  75,
  window.innerWidth * 0.7 / window.innerHeight,
  0.1,
  1000
);

const renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth * 0.7, window.innerHeight);
document.getElementById("scene").appendChild(renderer.domElement);

// Light
const light = new THREE.DirectionalLight(0xffffff, 1);
light.position.set(5, 10, 7);
scene.add(light);

// Ground
const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(200, 200),
  new THREE.MeshPhongMaterial({ color: 0x228B22 })
);
ground.rotation.x = -Math.PI / 2;
scene.add(ground);

// Drone
const drone = new THREE.Mesh(
  new THREE.BoxGeometry(1, 0.3, 1),
  new THREE.MeshPhongMaterial({ color: 0x333333 })
);
drone.position.y = 0.5;
scene.add(drone);

// Physics
let velocity = new THREE.Vector3();
const gravity = -9.8;
let thrust = 0;

function animate() {
  requestAnimationFrame(animate);

  const dt = 0.016;

  velocity.y += gravity * dt;
  velocity.y += thrust * dt;

  drone.position.add(velocity.clone().multiplyScalar(dt));

  if (drone.position.y < 0.5) {
    drone.position.y = 0.5;
    velocity.y = 0;
  }

  camera.position.set(8, 6, 8);
  camera.lookAt(drone.position);

  renderer.render(scene, camera);
}

animate();

/* =========================
   DRONE FUNCTIONS
========================= */

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

async function takeoff(height) {
  while (drone.position.y < height) {
    thrust = 15;
    await sleep(50);
  }
  thrust = 9.8;
}

async function land() {
  thrust = 0;
  while (drone.position.y > 0.5) {
    await sleep(50);
  }
}

async function moveForward(distance) {
  let moved = 0;
  while (moved < distance) {
    drone.position.z -= 0.1;
    moved += 0.1;
    await sleep(50);
  }
}

async function rotateDrone(deg) {
  let rotated = 0;
  const step = Math.sign(deg) * 2;
  while (Math.abs(rotated) < Math.abs(deg)) {
    drone.rotation.y += THREE.MathUtils.degToRad(step);
    rotated += step;
    await sleep(20);
  }
}

/* =========================
   BLOCKLY SETUP
========================= */

const toolbox = `
<xml>
  <block type="takeoff_block"></block>
  <block type="move_block"></block>
  <block type="rotate_block"></block>
  <block type="land_block"></block>
</xml>
`;

const workspace = Blockly.inject('blocklyDiv', {
  toolbox: toolbox
});

/* =========================
   BLOCK DEFINITIONS
========================= */

Blockly.Blocks['takeoff_block'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("Take off to height")
        .appendField(new Blockly.FieldNumber(5), "HEIGHT");
    this.setPreviousStatement(true);
    this.setNextStatement(true);
    this.setColour(200);
  }
};

Blockly.Blocks['move_block'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("Move forward")
        .appendField(new Blockly.FieldNumber(5), "DIST");
    this.setPreviousStatement(true);
    this.setNextStatement(true);
    this.setColour(120);
  }
};

Blockly.Blocks['rotate_block'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("Rotate")
        .appendField(new Blockly.FieldNumber(90), "DEG")
        .appendField("degrees");
    this.setPreviousStatement(true);
    this.setNextStatement(true);
    this.setColour(60);
  }
};

Blockly.Blocks['land_block'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("Land");
    this.setPreviousStatement(true);
    this.setNextStatement(true);
    this.setColour(20);
  }
};

/* =========================
   CODE GENERATORS
========================= */

Blockly.JavaScript['takeoff_block'] = function(block) {
  const height = block.getFieldValue('HEIGHT');
  return `await takeoff(${height});\n`;
};

Blockly.JavaScript['move_block'] = function(block) {
  const dist = block.getFieldValue('DIST');
  return `await moveForward(${dist});\n`;
};

Blockly.JavaScript['rotate_block'] = function(block) {
  const deg = block.getFieldValue('DEG');
  return `await rotateDrone(${deg});\n`;
};

Blockly.JavaScript['land_block'] = function(block) {
  return `await land();\n`;
};

/* =========================
   RUN BUTTON
========================= */

document.getElementById("runButton").onclick = async function() {
  const code = Blockly.JavaScript.workspaceToCode(workspace);
  try {
    await eval(`(async()=>{${code}})()`);
  } catch (e) {
    console.error(e);
    alert(e);
  }
};
</script>

</body>
</html>
