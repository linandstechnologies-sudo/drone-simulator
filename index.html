<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Drone Simulator</title>

<!-- THREE JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<!-- BLOCKLY STABLE BUILD -->
<script src="https://unpkg.com/blockly@10.4.3/blockly_compressed.js"></script>
<script src="https://unpkg.com/blockly@10.4.3/blocks_compressed.js"></script>
<script src="https://unpkg.com/blockly@10.4.3/javascript_compressed.js"></script>
<script src="https://unpkg.com/blockly@10.4.3/msg/en.js"></script>

<!-- remove favicon error -->
<link rel="icon" href="data:,">

<style>
body {
  margin:0;
  display:flex;
  height:100vh;
  overflow:hidden;
}
#scene { width:70%; height:100%; }
#blocklyDiv { width:30%; height:100%; }
#runButton {
  position:absolute;
  top:10px;
  right:10px;
  z-index:10;
  padding:10px 20px;
}
</style>
</head>

<body>

<button id="runButton">Run Code</button>

<div id="scene"></div>
<div id="blocklyDiv"></div>

<script>
/* =====================
   THREE JS SETUP
===================== */

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87CEEB);

const camera = new THREE.PerspectiveCamera(
  75,
  window.innerWidth * 0.7 / window.innerHeight,
  0.1,
  1000
);

const renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth * 0.7, window.innerHeight);
document.getElementById("scene").appendChild(renderer.domElement);

const light = new THREE.DirectionalLight(0xffffff,1);
light.position.set(5,10,7);
scene.add(light);

const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(200,200),
  new THREE.MeshPhongMaterial({color:0x228B22})
);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

const drone = new THREE.Mesh(
  new THREE.BoxGeometry(1,0.3,1),
  new THREE.MeshPhongMaterial({color:0x333333})
);
drone.position.y = 0.5;
scene.add(drone);

let velocity = new THREE.Vector3();
let thrust = 0;
const gravity = -9.8;

function animate(){
  requestAnimationFrame(animate);

  const dt = 0.016;

  velocity.y += gravity*dt;
  velocity.y += thrust*dt;

  drone.position.add(velocity.clone().multiplyScalar(dt));

  if(drone.position.y < 0.5){
    drone.position.y = 0.5;
    velocity.y = 0;
  }

  camera.position.set(8,6,8);
  camera.lookAt(drone.position);

  renderer.render(scene,camera);
}
animate();

/* =====================
   DRONE FUNCTIONS
===================== */

function sleep(ms){
  return new Promise(r=>setTimeout(r,ms));
}

async function takeoff(height){
  while(drone.position.y < height){
    thrust = 15;
    await sleep(50);
  }
  thrust = 9.8;
}

async function land(){
  thrust = 0;
  while(drone.position.y > 0.5){
    await sleep(50);
  }
}

async function moveForward(dist){
  let moved = 0;
  while(moved < dist){
    drone.position.z -= 0.1;
    moved += 0.1;
    await sleep(50);
  }
}

async function rotateDrone(deg){
  let rotated = 0;
  const step = Math.sign(deg)*2;
  while(Math.abs(rotated) < Math.abs(deg)){
    drone.rotation.y += THREE.MathUtils.degToRad(step);
    rotated += step;
    await sleep(20);
  }
}

/* =====================
   BLOCKLY SETUP
===================== */

const toolbox = `
<xml>
  <block type="takeoff_block"></block>
  <block type="move_block"></block>
  <block type="rotate_block"></block>
  <block type="land_block"></block>
</xml>
`;

const workspace = Blockly.inject('blocklyDiv',{
  toolbox: toolbox
});

/* =====================
   BLOCK DEFINITIONS
===================== */

Blockly.defineBlocksWithJsonArray([
{
  "type":"takeoff_block",
  "message0":"Take off to height %1",
  "args0":[
    {
      "type":"field_number",
      "name":"HEIGHT",
      "value":5
    }
  ],
  "previousStatement":null,
  "nextStatement":null,
  "colour":200
},
{
  "type":"move_block",
  "message0":"Move forward %1",
  "args0":[
    {
      "type":"field_number",
      "name":"DIST",
      "value":5
    }
  ],
  "previousStatement":null,
  "nextStatement":null,
  "colour":120
},
{
  "type":"rotate_block",
  "message0":"Rotate %1 degrees",
  "args0":[
    {
      "type":"field_number",
      "name":"DEG",
      "value":90
    }
  ],
  "previousStatement":null,
  "nextStatement":null,
  "colour":60
},
{
  "type":"land_block",
  "message0":"Land",
  "previousStatement":null,
  "nextStatement":null,
  "colour":20
}
]);

/* =====================
   GENERATOR (FIXED FOR v10)
===================== */

const javascriptGenerator = Blockly.JavaScript;

javascriptGenerator.forBlock['takeoff_block'] = function(block, generator) {
  const height = block.getFieldValue('HEIGHT');
  return `await takeoff(${height});\n`;
};

javascriptGenerator.forBlock['move_block'] = function(block, generator) {
  const dist = block.getFieldValue('DIST');
  return `await moveForward(${dist});\n`;
};

javascriptGenerator.forBlock['rotate_block'] = function(block, generator) {
  const deg = block.getFieldValue('DEG');
  return `await rotateDrone(${deg});\n`;
};

javascriptGenerator.forBlock['land_block'] = function(block, generator) {
  return `await land();\n`;
};

/* =====================
   RUN BUTTON
===================== */

document.getElementById("runButton").onclick = async function(){
  const code = javascriptGenerator.workspaceToCode(workspace);

  try{
    await eval(`(async()=>{${code}})()`);
  }catch(e){
    console.error(e);
    alert(e);
  }
};
</script>

</body>
</html>
